# 🔐 تدقيق شامل لنظام الصلاحيات - التطبيق المحمول والويب

## 📋 جدول المحتويات
1. [القواعد الأساسية للصلاحيات](#القواعد-الأساسية)
2. [الأدوار والوظائف](#الأدوار-والوظائف)
3. [تدقيق الصفحات والأزرار](#تدقيق-الصفحات)
4. [الصلاحيات المطلوب تطبيقها في الويب](#الصلاحيات-المطلوب-تطبيقها)

---

## 🎯 القواعد الأساسية للصلاحيات

### 1. **منطق الصلاحيات الأساسي (من ValidityUser.tsx)**

```javascript
// التطبيق المحمول - Src/functions/Login/ValidityUser.tsx
const KnowValidity = (kind, users = user) => {
  return new Promise(async (resolve, reject) => {
    try {
      // 1. Admin لديه كل الصلاحيات
      if (users.data.job === 'Admin') {
        return resolve(true);
      }
      
      // 2. مدير الفرع لديه كل الصلاحيات ماعدا 'Admin'
      if(boss === 'مدير الفرع' && kind !== 'Admin'){
        return resolve(true);
      }
      
      // 3. فحص الصلاحية في مصفوفة Validity
      return Array.isArray(Validity) 
        ? resolve(Validity.includes(kind)) 
        : resolve(false);
    } catch (error) {
      reject(error);
    }
  });
};
```

### 2. **قاعدة خاصة: المالية = Admin**

```javascript
// في HomeAdmin.tsx السطر 119
let job = users?.data?.job === 'مالية' ? 'Admin' : users?.data?.job;
```

**معنى هذا:** المستخدم الذي وظيفته "مالية" يُعامل كـ Admin في معظم العمليات!

---

## 👥 الأدوار والوظائف

### الوظائف الرئيسية (job)
1. **Admin** - المشرف العام
2. **مالية** - المالية (يُعامل كـ Admin)
3. **مدير الفرع** - مدير الفرع
4. **مدير عام** - مدير عام
5. **مدير تنفيذي** - مدير تنفيذي
6. **موارد بشرية** - موارد بشرية
7. **موظف** - موظف عادي

### الوظائف التفصيلية (jobdiscrption)
1. **موظف** - الموظف العادي
2. **مهندس الموقع** - مهندس موقع
3. **مهندس مشروع** - مهندس مشروع
4. **مشرف الموقع** - مشرف موقع
5. **مستشار جودة** - مستشار جودة
6. **محاسب** - محاسب
7. **مسئول طلبيات** - مسئول طلبيات
8. **مالك** - مالك

---

## 📱 تدقيق الصفحات والأزرار

### 1️⃣ **الصفحة الرئيسية للمشرف (HomeAdmin.tsx)**

#### ✅ الأزرار الموجودة:

| الزر | الشرط | الصلاحية المطلوبة | الحالة في الويب |
|------|-------|-------------------|-----------------|
| **إنشاء فرع** | `job === 'Admin'` | Admin فقط | ✅ مطبق |
| **العهد** | `job === 'Admin'` | Admin فقط (لكن يفحص covenant عند الضغط) | ✅ مطبق |

**الكود من التطبيق:**
```javascript
// السطر 439-461
{job === 'Admin' && (
  <ButtonCreat
    onpress={async () => {
      const results = await Uservalidation('covenant');
      navigation.navigate('CovenantBrinsh', {
        IDCompanyBransh: 0,
        Acceptingcovenant: results,
      });
    }}
    text="العهد"
    number={BrinshData?.Covenantnumber}
  />
)}
```

---

### 2️⃣ **صفحة الفرع (HomSub.tsx)**

#### ✅ الأزرار الموجودة:

| الزر | الشرط | الصلاحية المطلوبة | الحالة في الويب |
|------|-------|-------------------|-----------------|
| **إنشاء مشروع** | `jobdiscrption === 'موظف'` | إنشاء المشروع | ⚠️ يحتاج مراجعة |
| **حذف مشروع** | عند الضغط | حذف المشروع | ⚠️ يحتاج مراجعة |
| **إغلاق مشروع** | عند الضغط | اغلاق المشروع | ⚠️ يحتاج مراجعة |
| **تعديل بيانات الفرع** | عند الضغط | تعديل بيانات الفرغ | ⚠️ يحتاج مراجعة |
| **المشاريع المغلقة** | عند الضغط | المشاريع المغلقة | ⚠️ يحتاج مراجعة |

**الكود من التطبيق:**
```javascript
// السطر 338-360 - زر إنشاء مشروع
<ButtonCreat
  styleButton={[
    styles.stylecreatproject,
    {
      display: user?.data?.jobdiscrption === 'موظف' ? 'flex' : 'none',
    },
  ]}
  onpress={async () => {
    if (await Uservalidation('إنشاء المشروع', 0)) {
      navigation.navigate('PageCreateProject', {
        IDCompanyBransh: IDCompanyBransh,
      });
    }
  }}
  text="انشاء مشروع"
/>
```

**⚠️ ملاحظة مهمة:** الزر يظهر فقط للموظفين (`jobdiscrption === 'موظف'`)، لكن عند الضغط يفحص صلاحية "إنشاء المشروع"!

---

### 3️⃣ **صفحة المشروع (PageHomeProject.tsx)**

#### ✅ الأزرار الموجودة:

| الزر | الشرط | الصلاحية المطلوبة | الحالة في الويب |
|------|-------|-------------------|-----------------|
| **إنشاء مهمة** | `jobdiscrption === 'موظف'` | إضافة مرحلة رئيسية | ✅ مطبق |
| **ترتيب المراحل** | عند الضغط | ترتيب المراحل | ⚠️ يحتاج مراجعة |
| **حذف مرحلة رئيسية** | عند الضغط | حذف مرحلة رئيسية | ⚠️ يحتاج مراجعة |
| **تعديل بيانات المشروع** | عند الضغط | تعديل بيانات المشروع | ⚠️ يحتاج مراجعة |
| **بدء تنفيذ المشروع** | عند الضغط | مدير الفرع | ⚠️ يحتاج مراجعة |

**الكود من التطبيق:**
```javascript
// السطر 333-351 - زر إنشاء مهمة
<View
  style={{
    flexDirection: rowS(),
    justifyContent: 'space-between',
    alignItems: size <= 5 ? 'center' : flexS(),
    display: user?.data?.jobdiscrption === 'موظف' ? 'flex' : 'none',
  }}>
  <ButtonCreat
    styleButton={{
      justifyContent: 'center',
      margin: 15,
      paddingHorizontal: scale(15),
    }}
    onpress={async () => {
      if (await Uservalidation('إضافة مرحلة رئيسية', idProject)) {
        setModulsBOOLEN({name: 'creatTask', verify: true});
      }
    }}
    text="انشاء مهمة"
  />
</View>
```

---

### 4️⃣ **صفحة المرحلة (Phase.tsx)**

#### ✅ الصلاحيات المستخدمة:

| العملية | الصلاحية المطلوبة | الحالة في الويب |
|---------|-------------------|-----------------|
| **حذف مرحلة فرعية** | حذف مرحلة فرعية | ⚠️ يحتاج مراجعة |
| **تعديل مرحلة فرعية** | تعديل مرحلة فرعية | ⚠️ يحتاج مراجعة |
| **تشييك الانجازات** | تشييك الانجازات الفرعية | ⚠️ يحتاج مراجعة |
| **تعديل مرحلة رئيسية** | تعديل مرحلة رئيسية | ⚠️ يحتاج مراجعة |
| **إقفال المرحلة** | اقفال المرحلة | ⚠️ يحتاج مراجعة |
| **إضافة مرحلة فرعية** | اضافة مرحلة فرعية | ⚠️ يحتاج مراجعة |

---

### 5️⃣ **صفحة المالية (Finance.tsx)**

#### ✅ الأزرار والصلاحيات:

| الزر/العملية | الشرط | الصلاحية المطلوبة | الحالة في الويب |
|--------------|-------|-------------------|-----------------|
| **إنشاء عملية** | `DisabledFinance === 'true'` | انشاء عمليات مالية | ✅ مطبق |
| **تعديل عملية** | `DisabledFinance === 'true'` | انشاء عمليات مالية | ✅ مطبق |
| **حذف عملية** | `DisabledFinance === 'true'` | انشاء عمليات مالية | ⚠️ يحتاج مراجعة |

**الكود من التطبيق:**
```javascript
// السطر 214-224
onpress={async () => {
  if (user?.DisabledFinance === 'true') {
    if (await Uservalidation('انشاء عمليات مالية', idProject)) {
      setEdit(null);
      setModulsBOOLEN({name: 'opreation', verify: true});
    }
  } else {
    Tostget('العمليات المالية اليدوية متوقفه حالياً');
  }
}}
```

**⚠️ ملاحظة:** هناك فحصين:
1. `DisabledFinance === 'true'` - العمليات اليدوية مفعلة
2. `Uservalidation('انشاء عمليات مالية')` - لديه صلاحية

---

### 6️⃣ **صفحة الأرشيف (Archives.tsx & ArchivesSub.tsx)**

#### ✅ الصلاحيات المستخدمة:

| العملية | الصلاحية المطلوبة | الحالة في الويب |
|---------|-------------------|-----------------|
| **إنشاء مجلد** | انشاء مجلد او تعديله | ⚠️ يحتاج مراجعة |
| **تعديل مجلد** | انشاء مجلد او تعديله | ⚠️ يحتاج مراجعة |
| **حذف مجلد** | انشاء مجلد او تعديله | ⚠️ يحتاج مراجعة |

---

### 7️⃣ **صفحة الطلبات (Requests.tsx)**

#### ✅ الصلاحيات المستخدمة:

| العملية | الصلاحية المطلوبة | الحالة في الويب |
|---------|-------------------|-----------------|
| **إنشاء طلب** | إنشاء طلبات | ⚠️ يحتاج مراجعة |

---

### 8️⃣ **صفحة التأخيرات (Delays.tsx)**

#### ✅ الصلاحيات المستخدمة:

| العملية | الصلاحية المطلوبة | الحالة في الويب |
|---------|-------------------|-----------------|
| **إضافة تأخير** | إضافة تأخيرات | ⚠️ يحتاج مراجعة |

---

### 9️⃣ **صفحة الإعدادات (Information.tsx)**

#### ✅ الأزرار الموجودة:

| الزر | الشرط | الحالة في الويب |
|------|-------|-----------------|
| **تفعيل/توقيف العمليات المالية** | `job === 'Admin'` | ✅ مطبق (في القائمة المنسدلة) |
| **اعتمادات** | `jobdiscrption === 'موظف'` | ✅ مطبق (في صفحة الإدارة) |
| **قرارات** | `jobdiscrption === 'موظف'` | ✅ مطبق (في صفحة الإدارة) |
| **استشارات** | `jobdiscrption === 'موظف'` | ✅ مطبق (في صفحة الإدارة) |
| **تحضير** | للجميع | ✅ مطبق (في صفحة الإدارة) |

**الكود من التطبيق:**
```javascript
// السطر 154-160 - زر تفعيل المالية
{user.data.jobdiscrption === 'موظف' && (
  <View style={{
    display: user?.data?.job === 'Admin' ? 'flex' : 'none',
  }}>
    {/* زر تفعيل/توقيف العمليات المالية */}
  </View>
)}
```

---

## 🔍 الصلاحيات المطلوب تطبيقها في الويب

### ❌ الصلاحيات المفقودة أو غير المطبقة بشكل كامل:

#### 1. **صفحة الفرع (Branch Page)**

**المطلوب:**
- ✅ زر "إنشاء مشروع" يظهر فقط للموظفين (`jobdiscrption === 'موظف'`)
- ✅ عند الضغط يفحص صلاحية "إنشاء المشروع"
- ✅ خيارات حذف/إغلاق المشروع تفحص الصلاحيات المناسبة

**الملف:** `src/app/(dashboard)/branch/[id]/projects/page.tsx`

---

#### 2. **صفحة المشروع (Project Page)**

**المطلوب:**
- ✅ زر "إنشاء مهمة" يظهر فقط للموظفين
- ✅ زر "ترتيب المراحل" يفحص صلاحية "ترتيب المراحل"
- ✅ زر "حذف مرحلة رئيسية" يفحص صلاحية "حذف مرحلة رئيسية"
- ✅ زر "تعديل بيانات المشروع" يفحص صلاحية "تعديل بيانات المشروع"
- ✅ زر "بدء تنفيذ المشروع" يفحص صلاحية "مدير الفرع"

**الملف:** `src/app/(dashboard)/project/[id]/page.tsx`

---

#### 3. **صفحة المرحلة (Phase Page)**

**المطلوب:**
- ✅ زر "حذف مرحلة فرعية" يفحص صلاحية "حذف مرحلة فرعية"
- ✅ زر "تعديل مرحلة فرعية" يفحص صلاحية "تعديل مرحلة فرعية"
- ✅ زر "تشييك الانجازات" يفحص صلاحية "تشييك الانجازات الفرعية"
- ✅ زر "تعديل مرحلة رئيسية" يفحص صلاحية "تعديل مرحلة رئيسية"
- ✅ زر "إقفال المرحلة" يفحص صلاحية "اقفال المرحلة"
- ✅ زر "إضافة مرحلة فرعية" يفحص صلاحية "اضافة مرحلة فرعية"

**الملف:** `src/app/(dashboard)/phase/[id]/page.tsx`

---

#### 4. **صفحة الأرشيف (Archives Page)**

**المطلوب:**
- ✅ زر "إنشاء مجلد" يفحص صلاحية "انشاء مجلد او تعديله"
- ✅ زر "تعديل مجلد" يفحص صلاحية "انشاء مجلد او تعديله"
- ✅ زر "حذف مجلد" يفحص صلاحية "انشاء مجلد او تعديله"

**الملف:** `src/app/(dashboard)/archives/page.tsx`

---

#### 5. **صفحة الطلبات (Requests Page)**

**المطلوب:**
- ✅ زر "إنشاء طلب" يفحص صلاحية "إنشاء طلبات"
- ✅ زر "تشييك الطلبات" يفحص صلاحية "تشييك الطلبات"

**الملف:** `src/app/(dashboard)/requests/page.tsx`

---

#### 6. **صفحة التأخيرات (Delays Page)**

**المطلوب:**
- ✅ زر "إضافة تأخير" يفحص صلاحية "إضافة تأخيرات"

**الملف:** `src/app/(dashboard)/delays/page.tsx`

---

#### 7. **صفحة المالية (Finance Page)**

**المطلوب:**
- ✅ فحص `DisabledFinance === 'true'` قبل السماح بالعمليات اليدوية
- ✅ زر "إنشاء عملية" يفحص صلاحية "انشاء عمليات مالية"
- ✅ زر "تعديل عملية" يفحص صلاحية "انشاء عمليات مالية"
- ✅ زر "حذف عملية" يفحص صلاحية "انشاء عمليات مالية"

**الملف:** `src/app/(dashboard)/finance/page.tsx`

---

## 📊 ملخص الحالة

### ✅ **مطبق بشكل صحيح:**
1. ✅ الصفحة الرئيسية - زر العهد
2. ✅ الصفحة الرئيسية - زر إنشاء فرع
3. ✅ صفحة الإعدادات - تفعيل المالية (في القائمة المنسدلة)
4. ✅ صفحة الإدارة - اعتمادات، قرارات، استشارات، تحضير
5. ✅ صفحة التحضير - زر إضافة صلاحيات HR
6. ✅ منطق الصلاحيات الأساسي في `useValidityUser.ts`

### ⚠️ **يحتاج مراجعة وتطبيق:**
1. ⚠️ صفحة الفرع - جميع الأزرار والصلاحيات
2. ⚠️ صفحة المشروع - جميع الأزرار والصلاحيات
3. ⚠️ صفحة المرحلة - جميع الأزرار والصلاحيات
4. ⚠️ صفحة الأرشيف - جميع الأزرار والصلاحيات
5. ⚠️ صفحة الطلبات - جميع الأزرار والصلاحيات
6. ⚠️ صفحة التأخيرات - جميع الأزرار والصلاحيات
7. ⚠️ صفحة المالية - فحص DisabledFinance

---

## 🎯 خطة التنفيذ

### المرحلة 1: صفحة الفرع ✅
- [ ] تطبيق شرط `jobdiscrption === 'موظف'` لزر إنشاء مشروع
- [ ] تطبيق صلاحية "إنشاء المشروع" عند الضغط
- [ ] تطبيق صلاحيات حذف/إغلاق المشروع
- [ ] تطبيق صلاحية "تعديل بيانات الفرغ"
- [ ] تطبيق صلاحية "المشاريع المغلقة"

### المرحلة 2: صفحة المشروع ✅
- [ ] تطبيق شرط `jobdiscrption === 'موظف'` لزر إنشاء مهمة
- [ ] تطبيق صلاحية "ترتيب المراحل"
- [ ] تطبيق صلاحية "حذف مرحلة رئيسية"
- [ ] تطبيق صلاحية "تعديل بيانات المشروع"
- [ ] تطبيق صلاحية "مدير الفرع" لبدء التنفيذ

### المرحلة 3: صفحة المرحلة ✅
- [ ] تطبيق جميع صلاحيات المراحل الفرعية
- [ ] تطبيق جميع صلاحيات المراحل الرئيسية
- [ ] تطبيق صلاحية تشييك الانجازات

### المرحلة 4: صفحات أخرى ✅
- [ ] صفحة الأرشيف - صلاحيات المجلدات
- [ ] صفحة الطلبات - صلاحيات الطلبات
- [ ] صفحة التأخيرات - صلاحيات التأخيرات
- [ ] صفحة المالية - فحص DisabledFinance

---

## 📝 ملاحظات مهمة

### 1. **الفرق بين job و jobdiscrption**
- `job`: الوظيفة الرئيسية (Admin, مالية, مدير الفرع، إلخ)
- `jobdiscrption`: الوظيفة التفصيلية (موظف، مهندس، مستشار، إلخ)

### 2. **قاعدة المالية = Admin**
```javascript
let job = users?.data?.job === 'مالية' ? 'Admin' : users?.data?.job;
```
هذه القاعدة مطبقة في التطبيق المحمول ولكن **ليست مطبقة في الويب حالياً**!

### 3. **فحص DisabledFinance**
```javascript
if (user?.DisabledFinance === 'true') {
  // السماح بالعمليات اليدوية
} else {
  Tostget('العمليات المالية اليدوية متوقفه حالياً');
}
```
هذا الفحص موجود في التطبيق المحمول ويجب تطبيقه في الويب.

### 4. **نمط الإخفاء في التطبيق المحمول**
```javascript
display: user?.data?.jobdiscrption === 'موظف' ? 'flex' : 'none'
```
يجب استخدام `<EmployeeOnly>` في الويب لتطبيق نفس المنطق.

---

## 🔧 الأدوات المتاحة في الويب

### 1. **مكونات الإخفاء:**
- `<EmployeeOnly>` - يظهر للموظفين فقط
- `<NonEmployeeOnly>` - يخفى عن الموظفين
- `<PermissionBasedVisibility permission="...">` - يظهر حسب الصلاحية
- `<AdminGuard>` - للمشرفين فقط
- `<JobBasedVisibility>` - حسب الوظيفة

### 2. **دوال الفحص:**
- `Uservalidation(permission, id)` - فحص الصلاحية مع رسالة خطأ
- `hasPermission(permission)` - فحص الصلاحية (boolean)
- `isAdmin()` - هل المستخدم Admin
- `isBranchManager()` - هل المستخدم مدير فرع
- `isEmployee()` - هل المستخدم موظف

---

## 🚀 الخطوات التالية

1. **مراجعة كل صفحة** في الويب ومقارنتها بالتطبيق المحمول
2. **تطبيق الصلاحيات المفقودة** باستخدام الأدوات المتاحة
3. **اختبار كل صلاحية** للتأكد من عملها بشكل صحيح
4. **توثيق التغييرات** في ملف منفصل

---

**تاريخ التدقيق:** 2025-10-01
**الحالة:** قيد التنفيذ
**المسؤول:** فريق التطوير


