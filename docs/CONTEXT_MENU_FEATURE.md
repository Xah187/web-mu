# ميزة القائمة السياقية للرسائل (Context Menu)

## نظرة عامة
تم إضافة قائمة سياقية (Context Menu) للرسائل في الويب تطابق وظائف التطبيق المحمول عند الضغط المطول على الرسالة.

## الميزات المضافة

### 1. القائمة السياقية (Context Menu)
عند الضغط بالزر الأيمن على أي رسالة، تظهر قائمة بالخيارات التالية:

#### أ. رد (Reply)
- **الوظيفة**: الرد على الرسالة المحددة
- **التنفيذ**: يتم تعيين الرسالة كرسالة مرد عليها والتركيز على منطقة الكتابة
- **متاح**: لجميع الرسائل

#### ب. معلومات (Info)
- **الوظيفة**: عرض معلومات تفصيلية عن الرسالة
- **التنفيذ**: فتح نافذة منبثقة تعرض:
  - اسم المرسل
  - التاريخ والوقت الكامل
  - نص الرسالة
  - معلومات الملف المرفق (الاسم، النوع، الحجم)
  - حالة الرسالة (تم الإرسال / قيد الإرسال)
  - معرف الرسالة (chatID)
- **متاح**: لجميع الرسائل

#### ج. نسخ الرسالة (Copy Message)
- **الوظيفة**: نسخ نص الرسالة إلى الحافظة
- **التنفيذ**: استخدام `navigator.clipboard.writeText()`
- **متاح**: فقط للرسائل التي تحتوي على نص

#### د. حذف الرسالة (Delete Message)
- **الوظيفة**: حذف الرسالة من الدردشة
- **التنفيذ**: 
  - إذا كانت الرسالة محلية فقط (لم ترسل بعد): حذف محلي فقط
  - إذا كانت الرسالة مرسلة: إرسال طلب حذف للسيرفر عبر Socket.IO
- **متاح في الحالات التالية**:
  - المستخدم هو المرسل والرسالة في نفس اليوم
  - أو الرسالة لم تصل بعد (`arrived = false`)
  - أو الرسالة ليس لها `chatID`
  - أو المستخدم Admin

#### هـ. إعادة إرسال (Resend)
- **الوظيفة**: إعادة إرسال الرسالة
- **التنفيذ**: 
  - للرسائل النصية والمواقع: إرسال مباشر عبر Socket.IO
  - للملفات: يحتاج إلى منطق خاص لإعادة الرفع (غير مدعوم حالياً)
- **متاح**: لجميع الرسائل

### 2. نافذة معلومات الرسالة (Message Info Modal)
نافذة منبثقة تعرض معلومات تفصيلية عن الرسالة:

#### المعلومات المعروضة:
1. **المرسل**: اسم المستخدم الذي أرسل الرسالة
2. **التاريخ والوقت**: تاريخ ووقت الإرسال بالتنسيق العربي الكامل
3. **الرسالة**: نص الرسالة (إن وجد)
4. **الملف المرفق**: معلومات الملف (إن وجد):
   - الاسم
   - النوع (MIME type)
   - الحجم (بالـ KB أو MB)
5. **الحالة**: حالة الرسالة (تم الإرسال / قيد الإرسال)
6. **معرف الرسالة**: رقم معرف الرسالة في قاعدة البيانات

## الملفات المضافة

### 1. `src/components/chat/MessageContextMenu.tsx`
مكون القائمة السياقية الذي يعرض الخيارات المتاحة.

**Props:**
```typescript
interface MessageContextMenuProps {
  message: any;                    // الرسالة المحددة
  position: { x: number; y: number }; // موقع القائمة
  onClose: () => void;             // إغلاق القائمة
  onReply: () => void;             // معالج الرد
  onInfo: () => void;              // معالج المعلومات
  onCopy: () => void;              // معالج النسخ
  onDelete: () => void;            // معالج الحذف
  onResend: () => void;            // معالج إعادة الإرسال
  currentUserName: string;         // اسم المستخدم الحالي
  userJob?: string;                // وظيفة المستخدم (للتحقق من Admin)
}
```

**الميزات:**
- عرض الخيارات بناءً على صلاحيات المستخدم
- تأثيرات hover على الخيارات
- إغلاق تلقائي عند النقر خارج القائمة
- دعم RTL (من اليمين لليسار)

### 2. `src/components/chat/MessageInfoModal.tsx`
مكون نافذة معلومات الرسالة.

**Props:**
```typescript
interface MessageInfoModalProps {
  message: any;        // الرسالة المراد عرض معلوماتها
  onClose: () => void; // إغلاق النافذة
}
```

**الميزات:**
- عرض شامل لجميع معلومات الرسالة
- تنسيق التاريخ والوقت بالعربية
- تحويل حجم الملف إلى KB/MB
- تصميم متجاوب
- زر إغلاق واضح

## الصفحات المدعومة

تم تطبيق جميع الميزات على الصفحات التالية:

1. **صفحة الدردشة الرئيسية**: `src/app/(dashboard)/chat/page.tsx`
   - تدعم جميع أنواع الدردشات (القرارات، الاستشارات، دردشات المشاريع)

2. **صفحة الاعتمادات (Settings)**: `src/app/(dashboard)/settings/approvals/page.tsx`
   - دردشة الاعتمادات الخاصة بالمستخدم

3. **صفحة الاعتمادات (Management)**: `src/app/(dashboard)/management/settings/approvals/page.tsx`
   - دردشة الاعتمادات الخاصة بالإدارة

## التعديلات على الملفات الموجودة

### `src/app/(dashboard)/chat/page.tsx`

#### 1. إضافة Imports:
```typescript
import MessageContextMenu from '@/components/chat/MessageContextMenu';
import MessageInfoModal from '@/components/chat/MessageInfoModal';
```

#### 2. إضافة States:
```typescript
const [contextMenu, setContextMenu] = useState<{ message: ChatMessage; x: number; y: number } | null>(null);
const [showMessageInfo, setShowMessageInfo] = useState<ChatMessage | null>(null);
```

#### 3. إضافة Handlers:
- `handleContextMenu()`: معالج الضغط بالزر الأيمن
- `handleCopyMessage()`: نسخ الرسالة
- `handleDeleteMessage()`: حذف الرسالة
- `handleResendMessage()`: إعادة إرسال الرسالة

#### 4. إضافة Event Handler:
```typescript
onContextMenu={(e) => handleContextMenu(e, m)}
```

#### 5. عرض المكونات:
```typescript
{contextMenu && <MessageContextMenu ... />}
{showMessageInfo && <MessageInfoModal ... />}
```

## كيفية الاستخدام

### للمستخدم:

#### طريقة 1: الضغط بالزر الأيمن (Desktop)
1. انقر بالزر الأيمن على أي رسالة
2. ستظهر قائمة بالخيارات المتاحة
3. اختر الخيار المطلوب

#### طريقة 2: الضغط المطول (Mobile/Touch)
1. اضغط مطولاً على الرسالة (500ms)
2. ستظهر القائمة السياقية مع جميع الخيارات
3. اختر الخيار المطلوب من القائمة

### للمطور:

#### إضافة خيار جديد:
1. أضف الخيار في `MessageContextMenu.tsx`:
```typescript
<button onClick={(e) => handleClick(e, onNewOption)}>
  خيار جديد
</button>
```

2. أضف المعالج في `page.tsx`:
```typescript
const handleNewOption = (message: ChatMessage) => {
  // منطق الخيار الجديد
};
```

3. مرر المعالج للمكون:
```typescript
<MessageContextMenu
  ...
  onNewOption={() => handleNewOption(contextMenu.message)}
/>
```

## التوافق مع التطبيق المحمول

### الوظائف المطابقة:
✅ **رد** - مطابق تماماً  
✅ **معلومات** - مطابق تماماً  
✅ **نسخ الرسالة** - مطابق تماماً  
✅ **حذف الرسالة** - مطابق تماماً (نفس الشروط)  
✅ **إعادة إرسال** - مطابق للرسائل النصية

### الاختلافات:
- **التطبيق المحمول**: يستخدم Modal منبثق من الأسفل
- **الويب**: يستخدم Context Menu في موقع النقر

## الاختبار

### اختبار القائمة السياقية:
1. افتح صفحة الدردشة
2. انقر بالزر الأيمن على رسالة
3. تحقق من ظهور القائمة
4. جرب كل خيار

### اختبار المعلومات:
1. افتح القائمة السياقية
2. اختر "معلومات"
3. تحقق من عرض جميع المعلومات بشكل صحيح

### اختبار النسخ:
1. افتح القائمة السياقية لرسالة نصية
2. اختر "نسخ الرسالة"
3. الصق في أي مكان للتحقق

### اختبار الحذف:
1. أرسل رسالة جديدة
2. افتح القائمة السياقية
3. اختر "حذف الرسالة"
4. تحقق من اختفاء الرسالة

### اختبار إعادة الإرسال:
1. أرسل رسالة نصية
2. افتح القائمة السياقية
3. اختر "إعادة إرسال"
4. تحقق من إرسال الرسالة مرة أخرى

## الملاحظات

- القائمة السياقية تغلق تلقائياً عند النقر خارجها
- نافذة المعلومات تغلق بالنقر على زر الإغلاق أو خارج النافذة
- حذف الرسالة يتطلب تأكيد ضمني (لا يوجد تأكيد منفصل حالياً)
- إعادة إرسال الملفات غير مدعومة حالياً (تحتاج إلى منطق إعادة رفع)

## إصلاح مشكلة الحذف من التطبيق المحمول

### المشكلة:
عندما يتم حذف رسالة من التطبيق المحمول، كانت الرسالة تُحذف من التطبيق المحمول فقط ولا تُحذف من الويب.

### السبب:
معالج `received_message` في الويب لم يكن يتحقق من `kind: 'delete'` ولم يكن يحذف الرسالة من القائمة.

### الحل:
تم إضافة معالجة خاصة لرسائل الحذف في جميع صفحات الدردشة:

#### 1. `src/app/(dashboard)/chat/page.tsx`:
```typescript
const handleReceived = (msg: ChatMessage) => {
  // معالجة رسائل الحذف - مثل التطبيق المحمول
  if (msg.kind === 'delete') {
    setMessages(prev => prev.filter(m => m.chatID !== msg.chatID));
    return;
  }

  // معالجة الرسائل الجديدة
  if (msg.kind === 'new' && senderName?.toLowerCase?.() !== currentUserName?.toLowerCase?.()) {
    const n = normalizeMessage(msg);
    addMessageSafely(n);
  }
};
```

#### 2. `src/app/(dashboard)/settings/approvals/page.tsx`:
```typescript
socketService.on('received_message', (msg: any) => {
  // معالجة رسائل الحذف
  if (msg.kind === 'delete') {
    setMessages(prev => prev.filter(m => m.chatID !== msg.chatID));
    return;
  }
  // ... باقي المعالجة
});
```

#### 3. `src/app/(dashboard)/management/settings/approvals/page.tsx`:
نفس المعالجة كما في الأعلى.

### النتيجة:
✅ الحذف من التطبيق المحمول يحذف الرسالة من الويب
✅ الحذف من الويب يحذف الرسالة من التطبيق المحمول
✅ التزامن الكامل بين الويب والتطبيق المحمول

## التحسينات المستقبلية

1. إضافة تأكيد قبل حذف الرسالة
2. دعم إعادة إرسال الملفات
3. إضافة خيار "تعديل الرسالة" (Edit)
4. إضافة خيار "تثبيت الرسالة" (Pin)
5. إضافة خيار "إعادة توجيه" (Forward)
6. إضافة إشعارات Toast عند نجاح/فشل العمليات

